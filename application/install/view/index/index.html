<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link href="__STATIC__assets/images/favicon.ico" rel="icon">
    <title>在线安装 - 小呆支付</title>
    <link rel="stylesheet" href="__STATIC__assets/libs/layui/css/layui.css"/>
    <link rel="stylesheet" href="__STATIC__assets/module/admin.css?v=318"/>
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
        /** 小组成员 */
        .console-user-group {
            position: relative;
            padding: 10px 0 10px 60px;
        }

        .console-user-group .console-user-group-head {
            width: 32px;
            height: 32px;
            position: absolute;
            top: 50%;
            left: 12px;
            margin-top: -16px;
            border-radius: 50%;
        }

        .console-user-group .layui-badge {
            position: absolute;
            top: 50%;
            right: 8px;
            margin-top: -10px;
        }

        .console-user-group .console-user-group-name {
            line-height: 1.2;
        }

        .console-user-group .console-user-group-desc {
            color: #8c8c8c;
            line-height: 1;
            font-size: 12px;
            margin-top: 5px;
        }
        /** 卡片轮播图样式 */
        .admin-carousel .layui-carousel-ind {
            position: absolute;
            top: -41px;
            text-align: right;
        }

        .admin-carousel .layui-carousel-ind ul {
            background: 0 0;
        }

        .admin-carousel .layui-carousel-ind li {
            background-color: #e2e2e2;
        }

        .admin-carousel .layui-carousel-ind li.layui-this {
            background-color: #999;
        }

        /** 广告位轮播图 */
        .admin-news .layui-carousel-ind {
            height: 45px;
        }

        .admin-news a {
            display: block;
            line-height: 70px;
            text-align: center;
        }
    </style>
</head>
<body>
<!-- 正文开始 -->
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-header">在线安装</div>
        <div class="layui-card-body">
            <div class="layui-tab layui-steps layui-steps-readonly" lay-filter="stepsDemoForget"
                 style="max-width: 600px;">
                <ul class="layui-tab-title">
                    <li class="layui-this">
                        <i class="layui-icon layui-icon-ok">1</i>
                        <span class="layui-steps-title">第一步</span>
                        <span class="layui-steps-content">环境检测</span>
                    </li>
                    <li>
                        <i class="layui-icon layui-icon-ok">2</i>
                        <span class="layui-steps-title">第二步</span>
                        <span class="layui-steps-content">数据库</span>
                    </li>
                    <li>
                        <i class="layui-icon layui-icon-ok">3</i>
                        <span class="layui-steps-title">第三步</span>
                        <span class="layui-steps-content">域名配置</span>
                    </li>
                    <li>
                        <i class="layui-icon layui-icon-ok">4</i>
                        <span class="layui-steps-title">第四步</span>
                        <span class="layui-steps-content">安装成功</span>
                    </li>
                </ul>
                <div class="layui-tab-content">
                    <div class="layui-tab-item layui-show">
                        <form class="layui-form">
                            <div class="layui-form-item">
                                <table class="layui-table" lay-even lay-skin="line" lay-size="sm">
                                    <thead>
                                        <tr>
                                            <th>环境</th>
                                            <th>最低配置</th>
                                            <th>当前配置</th>
                                            <th>是否符合</th>
                                        </tr>
                                    </thead> 
                                    <tbody>
                                        <tr>
                                            <td>操作系统</td>
                                            <td>不限</td>
                                            <td>{:php_uname('s').php_uname('r')}</td>
                                            <td><span class="layui-badge layui-badge-green">符合</span></td>
                                        </tr>
                                        <tr>
                                            <td>运行环境</td>
                                            <td>不限</td>
                                            <td>{:$_SERVER["SERVER_SOFTWARE"]}</td>
                                            <td><span class="layui-badge layui-badge-green">符合</span></td>
                                        </tr>
                                        <tr>
                                            <td>上传附件限制</td>
                                            <td>20M</td>
                                            <td>{:ini_get('upload_max_filesize')}</td>
                                            <td><span class="layui-badge layui-badge-green">符合</span></td>
                                        </tr>
                                        <tr>
                                            <td>执行时间限制</td>
                                            <td>10 秒</td>
                                            <td>{:ini_get('max_execution_time')} 秒</td>
                                            <td><span class="layui-badge layui-badge-green">符合</span></td>
                                        </tr>
                                        <tr>
                                            <td>PHP框架</td>
                                            <td>不限</td>
                                            <td>ThinkPHP {:think\\App::VERSION}</td>
                                            <td><span class="layui-badge layui-badge-green">符合</span></td>
                                        </tr>
                                        <tr>
                                            <td>PHP版本</td>
                                            <td>7.0</td>
                                            <td>{$data.PHP_VERSION}</td>
                                            <td>{if condition="$data.PHP_VERSION gt '7.0'"}<span class="layui-badge layui-badge-green">符合</span>{else /}<span class="layui-badge layui-badge-danger">不符</span>{/if}</td>
                                        </tr>
                                        <tr>
                                            <td>域名 | IP</td>
                                            <td>不限</td>
                                            <td>{:$_SERVER['SERVER_NAME']} [{:gethostbyname($_SERVER['SERVER_NAME'])}]</td>
                                            <td><span class="layui-badge layui-badge-green">符合</span></td>
                                        </tr>
                                        <tr>
                                            <td>剩余空间</td>
                                            <td>不限</td>
                                            <td>{:round((disk_free_space(".")/(1024*1024)),2)} M</td>
                                            <td><span class="layui-badge layui-badge-green">符合</span></td>
                                        </tr>
                                        <tr>
                                            <td>服务器时间</td>
                                            <td>不限</td>
                                            <td>{:date("Y年n月j日 H:i:s")}</td>
                                            <td><span class="layui-badge layui-badge-green">符合</span></td>
                                        </tr>
                                    </tbody> 
                                </table>
                            </div>
                            <div class="layui-form-item">
                                <div class="layui-input-auto">
                                    <button class="layui-btn layui-btn-fluid layui-btn-radius"
                                            lay-filter="stepDemoFormSubmit1" lay-submit>下一步
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="layui-tab-item">
                        <form class="layui-form">
                            <div class="layui-form-item">
                                <label class="layui-form-label layui-form-required">SQL类型:</label>
                                <div class="layui-input-block">
                                    <input name="type" placeholder="请输入数据库类型" value="mysql" 
                                           class="layui-input" lay-verType="tips" lay-verify="required" required>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <label class="layui-form-label layui-form-required">服务器:</label>
                                <div class="layui-input-block">
                                    <input name="hostname" placeholder="请输入服务器地址" value="127.0.0.1" 
                                           class="layui-input" lay-verType="tips" lay-verify="required" required>
                                </div>
                            </div>
                            <div class="layui-form-item layui-form-text">
                                <label class="layui-form-label layui-form-required">端口:</label>
                                <div class="layui-input-block">
                                    <input name="hostport" placeholder="请输入数据库端口" value="3306" class="layui-input"
                                           lay-verType="tips" lay-verify="required" required/>
                                </div>
                            </div>
                            <div class="layui-form-item layui-form-text">
                                <label class="layui-form-label layui-form-required">数据库名:</label>
                                <div class="layui-input-block">
                                    <input name="database" placeholder="请输入数据库名" class="layui-input"
                                           lay-verType="tips" lay-verify="required" required/>
                                </div>
                            </div>
                            <div class="layui-form-item layui-form-text">
                                <label class="layui-form-label layui-form-required">用户名:</label>
                                <div class="layui-input-block">
                                    <input name="username" placeholder="请输入数据库用户名" class="layui-input"
                                           lay-verType="tips" lay-verify="required" required/>
                                </div>
                            </div>
                            <div class="layui-form-item layui-form-text">
                                <label class="layui-form-label layui-form-required">密码:</label>
                                <div class="layui-input-block">
                                    <input name="password" placeholder="请输入数据库密码" class="layui-input"
                                           lay-verType="tips" lay-verify="required" required/>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <div class="layui-input-block">
                                    <button data-steps="prev" type="button"
                                            class="layui-btn layui-btn-primary layui-btn-radius">上一步
                                    </button>
                                    <button class="layui-btn layui-btn-radius" lay-filter="stepDemoFormSubmit2"
                                            lay-submit>下一步
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="layui-tab-item">
                        <form class="layui-form">
                            <div class="layui-form-item layui-form-text">
                                <label class="layui-form-label layui-form-required">主域名:</label>
                                <div class="layui-input-block">
                                    <input name="url" placeholder="请输入主域名（不要带http://）" value="{:$_SERVER['SERVER_NAME']}" class="layui-input"
                                           lay-verType="tips" lay-verify="required" required/>
                                </div>
                            </div>
                            <div class="layui-form-item layui-form-text">
                                <label class="layui-form-label layui-form-required">支付域名:</label>
                                <div class="layui-input-block">
                                    <input name="url_api" placeholder="请输入支付域名（不要带http://）" class="layui-input"
                                           lay-verType="tips" lay-verify="required" required/>
                                </div>
                            </div>
                            <div class="layui-form-item layui-form-text">
                                <label class="layui-form-label layui-form-required">监控域名:</label>
                                <div class="layui-input-block">
                                    <input name="url_jk" placeholder="请输入监控域名（不要带http://）" class="layui-input"
                                           lay-verType="tips" lay-verify="required" required/>
                                </div>
                            </div>
                            <div class="layui-form-item">
                                <div class="layui-input-block">
                                    <button class="layui-btn layui-btn-radius" lay-filter="stepDemoFormSubmit3"
                                            lay-submit>确认安装
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="layui-tab-item">
                        <form class="layui-form">
                            
                            <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
                                <legend>宝塔计划任务</legend>
                            </fieldset>
                            <pre class="layui-code" lay-title="JavaScript" lay-skin="notepad">{if condition="strpos(php_uname('s'),'Windows') eq 'false'"}
计划任务-任务类型：访问URl
任务名称：随便取
执行周期：N分钟：1分钟
URL地址：{:url('/','','',config('url_jk'))}cehsald?user=管理员账号
{else /}
计划任务-任务类型：Shell脚本
任务名称：随便取
执行周期：N分钟：1分钟
脚本内容：（有两种脚本命令选择一个就可以呀）(推荐第一个)

step=15 #间隔的秒数，不能大于60
for (( i = 0; i < 60; i=(i+step) )); do
php /www/wwwroot/根目录路径/think SendMessage #填写您的根目录路径
sleep $step    
done    
exit 0



step=15 #间隔的秒数，不能大于60      
for (( i = 0; i < 60; i=(i+step) )); do    
    curl  -sS --connect-timeout 10 -m 60 '{:url('/','','',config('url_jk'))}cehsald?user=管理员账号'   #填写您的监控信息
echo "" 
endDate=`date +"%Y-%m-%d %H:%M:%S"`    
echo "[$endDate] Successful"    
echo "------------------------------------------------" 
sleep $step    
done    
exit 0
{/if}</pre>
                            <div class="layui-form-item">
                                <div class="layui-input-auto">
                                    <button class="layui-btn layui-btn-fluid layui-btn-radius"
                                            lay-filter="stepDemoFormSubmit4" lay-submit>安装完成
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <!-- //分布表单结束 -->
                    <hr>
                    <div style="padding: 10px 30px 20px 30px;">
                        <h3>温馨提示</h3><br>
                        <h4>第一步</h4>
                        <p class="layui-text text-danger">您先检测系统是否符合安装环境。</p>
                        <br><h4>第二步</h4>
                        <p class="layui-text text-danger">请输入您要对接的数据库详细信息，才能导入数据库。</p>
                        <br><h4>第三步</h4>
                        <p class="layui-text text-danger">按照域名配置填写您的指定域名(唯一)绑定访问（安全）。</p>
                        <br><h4>第四步</h4>
                        <p class="layui-text text-danger">按照提示说明配置您的宝塔计划任务（不配置影响回调问题）。</p>
                        <br><h4>安装完成</h4>
                        <p class="layui-text text-danger">（默认）管理员账号密码：admin</p>
                    </div>    
                </div>
            </div>
        </div>
    </div>
    
    
    <div class="layui-row layui-col-space15">
        <div class="layui-col-md4">
            <div class="layui-card">
                <div class="layui-card-header">版本信息</div>
                <div class="layui-card-body dynamic-card-body mini-bar">
                    <table class="layui-table layui-text">
                    <colgroup>
                        <col width="90">
                        <col>
                    </colgroup>
                    <tbody>
                    <script type="text/html" ew-tpl>
                        <tr>
                            <td>PHP框架</td>
                            <td>ThinkPHP</td>
                        </tr>
                        <tr>
                            <td>框架版本</td>
                            <td>{:think\\App::VERSION}</td>
                        </tr>
                        <tr>
                            <td>模板框架</td>
                            <td>EasyWeb</td>
                        </tr>
                        <tr>
                            <td>模板版本</td>
                            <td>{{layui.admin.version}}</td>
                        </tr>
                    </script>
                        <tr>
                            <td>主要特色</td>
                            <td>免签 / 多通道 / 简约 / 易上手 / 易支付</td>
                        </tr>
                        <tr>
                            <td>源码版本</td>
                            <td>{:config('ver')}</td>
                        </tr>
                        <tr>
                            <td>交流群</td>
                            <td><a href="https://jq.qq.com/?_wv=1027&k=BDyDO79O" class="layui-btn layui-btn-sm layui-bg-red"
                                   target="_blank">562946576</a></td>
                        </tr>
                    </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="layui-col-md4">
            <div class="layui-card">
                <div class="layui-card-header">开发成员</div>
                <div class="layui-card-body">
                    <div class="console-user-group">
                        <img src="//s.p.qq.com/pub/get_face?img_type=3&uin=1991292318" class="console-user-group-head" alt=""/>
                        <div class="console-user-group-name">呆呆</div>
                        <div class="console-user-group-desc">源码作者</div>
                        <a href="//wpa.qq.com/msgrd?v=3&uin=1991292318&site=qq&menu=yes" target="_blank"><span class="layui-badge layui-badge-green">Q Q 联系</span></a> 
                    </div>
                </div>
            </div>
        </div>
        <div class="layui-col-md4">
            <div class="layui-card">
                <div class="layui-card-header">友情链接</div>
                <div class="layui-card-body dynamic-card-body mini-bar">
                    <div class="layui-carousel admin-carousel admin-news" id="workplaceNewsCarousel">
                        <div carousel-item>
                            <div>
                                <a href="//92w.cc" target="_blank"
                                   style="color:#fff;background-color: #34363f;background-image: linear-gradient(to right,#34363f,#676c7c);">
                                    呆呆博客</a>
                            </div>
                            <div>
                                <a href="//eleadmin.com" target="_blank"
                                   style="color:#fff;background-color: #009688;background-image: linear-gradient(to right,#009688,#5fb878);">
                                    EleAdmin官方</a>
                            </div>
                            <div>
                                <a href="//www.thinkphp.cn" target="_blank"
                                   style="color:#fff;background-color: #009688;background-image: linear-gradient(to right,#009688,#5fb878);">
                                    ThinkPHP官方</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-card">
                <div class="layui-card-header">免责声明</div>
                <div class="layui-card-body dynamic-card-body mini-bar">
                    <ul class="layui-timeline layui-timeline-dynamic">      
                        <li>
                            <p>1, 小呆支付源码请用于正规用途！！</p> 
                            <p>2, 小呆支付源码只供学习使用，如用于商业活动与作者无关！！</p> 
                            <p>3, 用来进行违反中国法律用户跟作者一切无关！！</p> 
                            <p>4, 不得将小呆支付源码和程序挪作商业或盈 利用途！！</p> 
                            <p>5, 请在下载后24小时内删除！否则，由此产生的后 果由挪用者本人负责，作者不承担任何法律责任！！</p> 
                            <p>6, 安装即认同以上原则！！</p> 
                        </li>      
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- js部分 -->
<script type="text/javascript" src="__STATIC__assets/libs/layui/layui.js"></script>
<script type="text/javascript" src="__STATIC__assets/js/common.js?v=318"></script>

<script>
    layui.use(['layer', 'steps', 'form', 'admin', 'carousel', 'formX', 'element','notice'], function () {
        var $ = layui.jquery;
        var layer = layui.layer;
        var steps = layui.steps;
        var form = layui.form;
        var carousel = layui.carousel;
        var device = layui.device();
        var admin = layui.admin;
        var formX = layui.formX;
        var notice = layui.notice;
        
        // 渲染轮播
        carousel.render({
            elem: '#workplaceNewsCarousel',
            width: '100%',
            height: '70px',
            arrow: 'none',
            autoplay: true,
            trigger: device.ios || device.android ? 'click' : 'hover',
            anim: 'fade'
        });
        
        // 环境检测
        form.on('submit(stepDemoFormSubmit1)', function (data) {
            admin.btnLoading('[lay-filter="stepDemoFormSubmit1"]');
            setTimeout(function () {
                admin.btnLoading('[lay-filter="stepDemoFormSubmit1"]', false);
                steps.next('stepsDemoForget');
            }, 600);
            return false;
        });

        // 数据库
        form.on('submit(stepDemoFormSubmit2)', function (data) {
            admin.btnLoading('[lay-filter="stepDemoFormSubmit2"]');
            setTimeout(function () {
                console.log(data.field);
                $.post("{:url('index/mysql')}", data.field, function (res) {
                    admin.btnLoading('[lay-filter="stepDemoFormSubmit2"]', false);
                    if (res.code === 1) {
                        notice.msg(res.msg, {icon: 1});
                        steps.next('stepsDemoForget');
                    } else {
                        notice.msg(res.msg, {icon: 2});
                    }
                }, 'json');
            }, 600);
            return false;
        });

        // 配置信息
        form.on('submit(stepDemoFormSubmit3)', function (data) {
            admin.btnLoading('[lay-filter="stepDemoFormSubmit3"]');
            setTimeout(function () {
                if(data.field.url!="{:$_SERVER['SERVER_NAME']}" || data.field.url_api!="{:$_SERVER['SERVER_NAME']}" || data.field.url_jk!="{:$_SERVER['SERVER_NAME']}"){
                    if(data.field.url==data.field.url_api || data.field.url==data.field.url_jk || data.field.url_api==data.field.url || data.field.url_api==data.field.url_jk || data.field.url_jk==data.field.url || data.field.url_jk==data.field.url_api){
                        admin.btnLoading('[lay-filter="stepDemoFormSubmit3"]', false);
                        notice.msg('域名配置错误', {icon: 2});
                    }else{
                        stepDemoFormSubmit3(data);
                    }
                }else{
                    stepDemoFormSubmit3(data);
                }
                
            }, 600);
            return false;
        });
        
        function stepDemoFormSubmit3(data){
            console.log(data.field);
            $.post("{:url('index/config')}", data.field, function (res) {
                admin.btnLoading('[lay-filter="stepDemoFormSubmit3"]', false);
                if (res.code === 1) {
                    notice.msg(res.msg, {icon: 1});
                    steps.next('stepsDemoForget');
                } else {
                    notice.msg(res.msg, {icon: 2});
                }
            }, 'json');
        }
        
        // 安装完成
        form.on('submit(stepDemoFormSubmit4)', function (data) {
            admin.btnLoading('[lay-filter="stepDemoFormSubmit4"]');
            setTimeout(function () {
                admin.btnLoading('[lay-filter="stepDemoFormSubmit4"]', false);
                window.location.href = "{:url('/','','',config('url'))}";
            }, 600);
            return false;
        });

    });
</script>
</body>
</html>